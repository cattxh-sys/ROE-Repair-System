<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEDç»´ä¿®ç³»ç»Ÿ v9.0 (è´¦æˆ·åŠ å¯†ç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007aff; --success: #34c759; --danger: #ff3b30; --warning: #ff9500; --secondary: #8e8e93; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #f2f2f7; margin: 0; padding: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 800px; margin: auto; min-height: 90vh; }
        .page { display: none; }
        .page.active { display: block; }
        .user-bar { background: #3a3a3c; color: white; padding: 12px 15px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .info-bar { background: var(--primary); color: white; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        label { display: block; margin: 15px 0 5px; font-weight: 600; color: #3a3a3c; }
        input, select { width: 100%; padding: 13px; border: 1px solid #d1d1d6; border-radius: 10px; margin-bottom: 5px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-outline { background: none; color: var(--primary); border: 1px solid var(--primary); }
        .hidden { display: none !important; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px; }
        th, td { border-bottom: 1px solid #e5e5ea; padding: 12px 8px; text-align: left; }
        .sync-badge { font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-left: 5px; color:white; }
        .synced { background: var(--success); }
        .not-synced { background: var(--warning); }
        .fault-row { background: #f0f0f5; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <div id="page_login" class="page active">
        <h2 style="text-align:center; margin-top:30px;">ğŸ” ç»´ä¿®ç³»ç»Ÿç™»å½•</h2>
        <label>ç”¨æˆ·å</label>
        <input type="text" id="login_user" placeholder="è¯·è¾“å…¥å§“åæˆ–å·¥å·">
        <label>å¯†ç </label>
        <input type="password" id="login_pass" placeholder="è¯·è¾“å…¥ç™»å½•å¯†ç ">
        <button class="btn-blue" id="loginBtn" onclick="secureLogin()">ç™»å½•</button>
        <p style="font-size: 12px; color: #8e8e93; text-align: center; margin-top: 20px;">æ•°æ®å°†è‡ªåŠ¨åŒæ­¥è‡³äº‘ç«¯è¡¨æ ¼</p>
    </div>

    <div id="page_list" class="page">
        <div class="user-bar">
            <span>ç»´ä¿®å‘˜ï¼š<strong id="display_user">--</strong></span>
            <button onclick="logout()" style="width:auto; padding:5px 10px; margin:0; background:none; color:#ff453a;">é€€å‡º</button>
        </div>
        <h3>ä»»åŠ¡æ¸…å•</h3>
        <div id="rma_list_container"></div>
        <button class="btn-blue" onclick="showPage('page_new_rma')">+ æ–°å»º RMA ç»´ä¿®æŠ¥å‘Š</button>
    </div>

    <div id="page_new_rma" class="page">
        <h2>ğŸ›  ä»»åŠ¡åˆå§‹åŒ–</h2>
        <input type="text" id="new_rma_input" placeholder="è¯·è¾“å…¥ RMA å•å·">
        <button class="btn-blue" onclick="const v=document.getElementById('new_rma_input').value; if(v){currentRMA=v; showPage('page_entry');}">è¿›å…¥å½•å…¥</button>
        <button class="btn-outline" onclick="showPage('page_list')">è¿”å›</button>
    </div>

    <div id="page_entry" class="page">
        <div class="info-bar">
            <span>RMA: <strong id="display_rma">--</strong></span>
            <button onclick="showPage('page_list')" style="width:auto; margin:0; padding:5px;">è¿”å›</button>
        </div>
        <label>æ¡ç  SN</label>
        <input type="text" id="barcode" placeholder="æ‰«ææˆ–è¾“å…¥æ¡ç ">
        <div id="faults_container"></div>
        <button class="btn-outline" onclick="addFaultRow()">+ å¢åŠ æ•…éšœé¡¹</button>
        <button class="btn-green" id="submitBtn" onclick="saveRecord()">ä¿å­˜å¹¶äº‘åŒæ­¥</button>
        
        <table>
            <thead><tr><th>æ¡ç </th><th>æ•…éšœ</th><th>å°è®¡</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="entry_body"></tbody>
        </table>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsFvoyLi5xzS4VR-j99DoymSfdRXRfI5wndSHGlEYsS-zvhv_nIdTkmhwE3QIoz1kmKw/exec"; 
    
    let records = JSON.parse(localStorage.getItem('led_repair_v9') || '[]');
    let currentUser = localStorage.getItem('repair_user') || "";
    let currentRMA = "";
    const priceMap = { "ç¢°æ’æ­»ç¯": 11, "ç¯ç æ•…éšœ": 0, "é¢ç½©æ›´æ¢": 3, "ICç»´ä¿®": 15, "ç”µè·¯æ¿ç»´ä¿®": 15, "å…¶ä»–": 0 };

    // é¡µé¢åˆå§‹åŒ–ï¼šæ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    window.onload = () => {
        if(currentUser) {
            document.getElementById('display_user').innerText = currentUser;
            showPage('page_list');
        }
    };

    async function secureLogin() {
        const user = document.getElementById('login_user').value.trim();
        const pass = document.getElementById('login_pass').value.trim();
        const btn = document.getElementById('loginBtn');
        if(!user || !pass) return alert("è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º");

        btn.disabled = true; btn.innerText = "éªŒè¯ä¸­...";
        try {
            const resp = await fetch(`${GOOGLE_SCRIPT_URL}?username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`);
            const result = await resp.text();
            if(result === "success") {
                currentUser = user;
                localStorage.setItem('repair_user', user); // è®°ä½ç™»å½•
                document.getElementById('display_user').innerText = user;
                showPage('page_list');
            } else {
                alert("è´¦å·æˆ–å¯†ç é”™è¯¯ï¼");
            }
        } catch (e) {
            alert("ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®Google");
        } finally {
            btn.disabled = false; btn.innerText = "ç™»å½•";
        }
    }

    function logout() {
        localStorage.removeItem('repair_user');
        currentUser = "";
        showPage('page_login');
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'page_list') renderRMAList();
        if(id === 'page_entry') {
            document.getElementById('display_rma').innerText = currentRMA;
            resetEntryPage();
        }
    }

    function addFaultRow(type="ç¢°æ’æ­»ç¯", qty=1) {
        const container = document.getElementById('faults_container');
        const div = document.createElement('div');
        div.className = 'fault-row';
        div.innerHTML = `
            <select class="f_type">${Object.keys(priceMap).map(k=>`<option value="${k}" ${k==type?'selected':''}>${k}</option>`).join('')}</select>
            <input type="number" class="f_qty" value="${qty}" style="margin-top:5px">
        `;
        container.appendChild(div);
    }

    async function saveRecord() {
        const bc = document.getElementById('barcode').value.trim();
        if(!bc) return alert("è¯·æ‰«ç ");
        const btn = document.getElementById('submitBtn');
        btn.disabled = true; btn.innerText = "æ­£åœ¨äº‘åŒæ­¥...";

        let faults = [], total = 0;
        document.querySelectorAll('.fault-row').forEach(row => {
            const t = row.querySelector('.f_type').value;
            const q = parseInt(row.querySelector('.f_qty').value);
            faults.push(`${t}*${q}`);
            total += (priceMap[t] * q);
        });

        const data = {
            id: Date.now(), rma: currentRMA, barcode: bc, 
            details: faults.join('; '), total: total,
            user: currentUser, time: new Date().toLocaleString(), synced: false
        };

        records.push(data);
        localStorage.setItem('led_repair_v9', JSON.stringify(records));

        // äº‘åŒæ­¥
        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify(data)
            });
            records[records.length-1].synced = true;
            localStorage.setItem('led_repair_v9', JSON.stringify(records));
        } catch(e) {}

        resetEntryPage();
        renderEntryTable();
        btn.disabled = false; btn.innerText = "ä¿å­˜å¹¶äº‘åŒæ­¥";
    }

    function renderEntryTable() {
        const tbody = document.getElementById('entry_body');
        const myData = records.filter(r => r.rma === currentRMA);
        tbody.innerHTML = myData.map(r => `
            <tr>
                <td>${r.barcode} ${r.synced?'<span class="sync-badge synced">å·²åŒæ­¥</span>':'<span class="sync-badge not-synced">æœ¬åœ°</span>'}</td>
                <td>${r.details}</td>
                <td>$${r.total}</td>
                <td><button onclick="alert('æš‚ä¸æ”¯æŒåˆ é™¤')" style="width:auto;margin:0;padding:2px 5px;font-size:10px;">åˆ </button></td>
            </tr>
        `).reverse().join('');
    }

    function renderRMAList() {
        const container = document.getElementById('rma_list_container');
        const rmas = [...new Set(records.filter(r=>r.user===currentUser).map(r=>r.rma))];
        container.innerHTML = rmas.map(rma => `<div style="padding:15px; background:#fff; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #ddd;">
            <b>${rma}</b>
            <button class="btn-blue" style="width:auto; margin:0; padding:5px 15px;" onclick="currentRMA='${rma}'; showPage('page_entry');">è¿›å…¥</button>
        </div>`).join('');
    }

    function resetEntryPage() {
        document.getElementById('barcode').value = "";
        document.getElementById('faults_container').innerHTML = "";
        addFaultRow();
        renderEntryTable();
    }
</script>
</body>
</html>